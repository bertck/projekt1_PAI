extends ../layout

block content
    if machine
        h1 Rezerwacje dla #{machine.name}
    else
        h1 Wszystkie rezerwacje
    #calendar.calendar
    .reservation-actions
        a.btn(href=machine ? `/reservations/new?machineId=${machine.id}` : '/reservations/new') Utwórz rezerwację
    - const grouped = {}
    each r in reservations
        - const mName = r.Machine.name
        - if(!grouped[mName]) grouped[mName] = []
        - grouped[mName].push(r)
    .reservation-groups
        each list, mName in grouped
            .reservation-group
                h2= mName
                ul.reservation-list
                    each res in list
                        li
                            a.nav-link(href=`/reservations/${res.id}`)= `${res.startDate} - ${res.endDate}`
    script.
        const reservations = !{JSON.stringify(reservations)};
        const calendar = document.getElementById('calendar');
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const first = new Date(year, month, 1);
        const last = new Date(year, month + 1, 0);
        const startDay = (first.getDay() + 6) % 7;
        let html = '<table><tr>';
        const days = ['Pn','Wt','Śr','Cz','Pt','So','Nd'];
        for (const d of days) html += `<th>${d}</th>`;
        html += '</tr><tr>';
        for (let i=0;i<startDay;i++) html += '<td></td>';
        const daysInMonth = last.getDate();
        for (let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const res = reservations.find(r => dateStr >= r.startDate && dateStr <= r.endDate);
            if(res){
                html += `<td class="reserved"><a class="nav-link" href="/reservations/${res.id}">${d}</a></td>`;
            } else {
                html += `<td>${d}</td>`;
            }
            if((startDay + d) % 7 ===0) html += '</tr><tr>';
        }
        html += '</tr></table>';
        calendar.innerHTML = html;