extends ../layout

block content
    .form-container
        h1 Dodaj rezerwację
        form(action='/reservations' method='post')
            label(for='machineId') Maszyna (wymagane)
            select(name='machineId' id='machineId', required)
                each machine in machines
                    option(value=machine.id, selected=(machine.id == selectedMachineId))= machine.name
            label(for='startDate') Od (max 3 mies. wprzód)
            input(type='date' name='startDate' id='startDate', required)
            label(for='endDate') Do (max 3 mies. wprzód)
            input(type='date' name='endDate' id='endDate', required)
            button.btn(type='submit') Zapisz
        script.
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            const today = new Date();
            today.setHours(0,0,0,0);
            const max = new Date();
            max.setMonth(max.getMonth() + 3);
            const todayStr = today.toISOString().split('T')[0];
            const maxStr = max.toISOString().split('T')[0];
            startInput.min = todayStr;
            endInput.min = todayStr;
            startInput.max = maxStr;
            endInput.max = maxStr;
            document.querySelector('form').addEventListener('submit', e => {
                const s = new Date(startInput.value);
                const en = new Date(endInput.value);
                if (s < today || en < today || s > en || s > max || en > max) {
                    e.preventDefault();
                    alert('Nieprawidłowe daty: początek przed dziś, początek po końcu lub poza zakresem 3 miesięcy');
                }
            });
        a.btn.back-link(href='/reservations') Wróć do listy rezerwacji
    #calendar.calendar
    script.
        const reservations = !{JSON.stringify(reservations || [])};
        const calendar = document.getElementById('calendar');
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const first = new Date(year, month, 1);
        const last = new Date(year, month + 1, 0);
        const startDay = (first.getDay() + 6) % 7;
        let html = '<table><tr>';
        const days = ['Pn','Wt','Śr','Cz','Pt','So','Nd'];
        for (const d of days) html += `<th>${d}</th>`;
        html += '</tr><tr>';
        for (let i=0;i<startDay;i++) html += '<td></td>';
        const daysInMonth = last.getDate();
        for (let d=1; d<=daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const res = reservations.find(r => dateStr >= r.startDate && dateStr <= r.endDate);
            if(res){
                html += `<td class="reserved"><a class="nav-link" href="/reservations/${res.id}">${d}</a></td>`;
            } else {
                html += `<td>${d}</td>`;
            }
            if((startDay + d) % 7 ===0) html += '</tr><tr>';
        }
        html += '</tr></table>';
        calendar.innerHTML = html;